<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alexandria ‚Äî Activity Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#0B1221',
              surface: '#0F162A',
              border: '#1F2A44',
              muted: '#94A3B8',
              primary: '#3B82F6',
              primaryDark: '#1D4ED8',
              success: '#10B981',
              warning: '#F59E0B',
              danger: '#EF4444',
            },
            boxShadow: {
              soft: '0 8px 30px rgba(0, 0, 0, 0.3)',
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-background text-slate-100">
    <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
      <header class="flex flex-col gap-4">
        <div class="flex flex-col gap-1">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Admin</p>
          <h1 class="text-3xl font-bold text-white">Activity Log</h1>
          <p class="text-slate-400"
            >Recent administrative create/update/delete actions.</p
          >
        </div>
        <div class="flex flex-wrap gap-3">
          <a
            href="{{ url_for('admin_apps_list') }}"
            class="inline-flex items-center gap-2 rounded-lg border border-border bg-surface px-4 py-2 text-sm font-medium text-slate-200 hover:border-slate-500 hover:bg-slate-900 transition"
          >
            <span>üìö</span> Apps
          </a>
          <a
            href="{{ url_for('admin_app_requests') }}"
            class="inline-flex items-center gap-2 rounded-lg border border-border bg-surface px-4 py-2 text-sm font-medium text-slate-200 hover:border-slate-500 hover:bg-slate-900 transition"
          >
            <span>üì•</span> Requests
          </a>
          <a
            href="{{ url_for('redirect_choice') }}"
            class="inline-flex items-center gap-2 rounded-lg border border-border bg-surface px-4 py-2 text-sm font-medium text-slate-200 hover:border-slate-500 hover:bg-slate-900 transition"
          >
            <span>üè†</span> Admin home
          </a>
        </div>
      </header>

      {% set page_total = logs|length %} {% set latest = logs[0].created_at_text
      if logs and logs[0].created_at_text else None %}

      <section class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div
          class="rounded-2xl border border-border/60 bg-surface p-4 shadow-soft flex items-center justify-between"
        >
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-400"
              >Entries this page</p
            >
            <p class="text-2xl font-semibold text-white">{{ page_total }}</p>
          </div>
          <div class="text-primary text-xl">üóÇÔ∏è</div>
        </div>
        <div
          class="rounded-2xl border border-border/60 bg-surface p-4 shadow-soft flex items-center justify-between"
        >
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-400"
              >Total entries</p
            >
            <p class="text-2xl font-semibold text-white">{{ total }}</p>
          </div>
          <div class="text-warning text-xl">üìà</div>
        </div>
        <div
          class="rounded-2xl border border-border/60 bg-surface p-4 shadow-soft flex items-center justify-between"
        >
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-400"
              >Latest event</p
            >
            <p class="text-2xl font-semibold text-white"
              >{{ latest if latest else '‚Äî' }}</p
            >
          </div>
          <div class="text-success text-xl">‚è±Ô∏è</div>
        </div>
      </section>

      <section
        class="rounded-2xl border border-border/60 bg-surface p-4 shadow-soft space-y-4"
      >
        <div
          class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
        >
          <div class="flex flex-1 items-center gap-3">
            <div class="relative w-full max-w-xl">
              <span
                class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"
                >üîç</span
              >
              <input
                id="logSearch"
                type="search"
                placeholder="Search by app, user, or details..."
                class="w-full rounded-lg border border-border bg-transparent pl-10 pr-3 py-2 text-sm text-white placeholder:text-slate-500 focus:border-primary focus:ring-2 focus:ring-primary/40 outline-none"
              />
            </div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <select
              id="actionFilter"
              class="rounded-lg border border-border bg-transparent px-3 py-2 text-sm text-white focus:border-primary focus:ring-2 focus:ring-primary/40 outline-none"
            >
              <option value="">Action: All</option>
              <option value="create">Create</option>
              <option value="update">Update</option>
              <option value="delete">Delete</option>
            </select>
            <div class="text-sm text-slate-400"
              >Showing {{ start + 1 }} - {{ start + logs|length }} of {{ total
              }}</div
            >
          </div>
        </div>

        <div class="overflow-hidden rounded-xl border border-border/60">
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="logsTable">
              <thead
                class="bg-surface border-b border-border/80 text-slate-400 uppercase text-xs tracking-wide"
              >
                <tr>
                  <th class="px-4 py-3 text-left">When</th>
                  <th class="px-4 py-3 text-left">Action</th>
                  <th class="px-4 py-3 text-left">App</th>
                  <th class="px-4 py-3 text-left">User</th>
                  <th class="px-4 py-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/60">
                {% if logs %} {% for a in logs %}
                <tr
                  class="hover:bg-white/5 transition"
                  data-action="{{ (a.action or '')|lower }}"
                  data-app="{{ (a.app_name or ('App #' ~ a.app_id) if a.app_id else a.app_name or '')|lower }}"
                  data-user="{{ (a.user_email or 'system')|lower }}"
                  data-details="{{ (a.details_text or '')|lower|e }}"
                >
                  <td class="px-4 py-3 whitespace-nowrap text-slate-200"
                    >{{ a.created_at_text or '‚Äî' }}</td
                  >
                  <td class="px-4 py-3">
                    {% set act = (a.action or '').lower() %} {% if act ==
                    'create' %}
                    <span
                      class="inline-flex items-center rounded-full bg-success/20 px-3 py-1 text-xs font-semibold text-success"
                      >Create</span
                    >
                    {% elif act == 'update' %}
                    <span
                      class="inline-flex items-center rounded-full bg-primary/20 px-3 py-1 text-xs font-semibold text-primary"
                      >Update</span
                    >
                    {% elif act == 'delete' %}
                    <span
                      class="inline-flex items-center rounded-full bg-danger/20 px-3 py-1 text-xs font-semibold text-danger"
                      >Delete</span
                    >
                    {% else %}
                    <span
                      class="inline-flex items-center rounded-full bg-slate-700/50 px-3 py-1 text-xs font-semibold text-slate-200"
                      >{{ a.action }}</span
                    >
                    {% endif %}
                  </td>
                  <td class="px-4 py-3 text-slate-200">
                    {% if a.app_id %}
                    <a
                      class="text-primary hover:underline"
                      href="{{ url_for('admin_edit_app', app_id=a.app_id) }}"
                      >{{ a.app_name or ('App #' ~ a.app_id) }}</a
                    >
                    {% else %} {{ a.app_name or '‚Äî' }} {% endif %}
                  </td>
                  <td class="px-4 py-3 text-slate-300"
                    >{{ a.user_email or 'system' }}</td
                  >
                  <td class="px-4 py-3">
                    <pre
                      class="max-h-32 overflow-auto rounded-lg border border-border/60 bg-background/50 px-3 py-2 text-xs text-slate-200 whitespace-pre-wrap"
                    >
{{ a.details_text }}</pre
                    >
                  </td>
                </tr>
                {% endfor %} {% else %}
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-slate-400"
                    >No log entries yet.</td
                  >
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <div
          class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between text-sm text-slate-400"
        >
          <div
            >Showing {{ start + 1 }} - {{ start + logs|length }} of {{ total
            }}</div
          >
          <div class="flex items-center gap-3">
            {% if page > 1 %}
            <a
              class="rounded-lg border border-border px-3 py-2 text-slate-200 hover:border-primary hover:text-primary transition"
              href="{{ url_for('admin_activity_log') }}?page={{ page-1 }}&per_page={{ per_page }}"
              >‚Äπ Prev</a
            >
            {% endif %} {% if (start + logs|length) < total %}
            <a
              class="rounded-lg border border-border px-3 py-2 text-slate-200 hover:border-primary hover:text-primary transition"
              href="{{ url_for('admin_activity_log') }}?page={{ page+1 }}&per_page={{ per_page }}"
              >Next ‚Ä∫</a
            >
            {% endif %}
          </div>
        </div>
      </section>
    </div>

    <script>
      const logSearch = document.getElementById('logSearch');
      const actionFilter = document.getElementById('actionFilter');
      const logRows = Array.from(
        document.querySelectorAll('#logsTable tbody tr')
      );

      function applyLogFilters() {
        const q = (logSearch?.value || '').trim().toLowerCase();
        const action = (actionFilter?.value || '').toLowerCase();

        logRows.forEach((row) => {
          const rowAction = row.dataset.action || '';
          const app = row.dataset.app || '';
          const user = row.dataset.user || '';
          const details = row.dataset.details || '';

          const matchesAction = !action || rowAction === action;
          const matchesSearch =
            !q || app.includes(q) || user.includes(q) || details.includes(q);

          row.style.display = matchesAction && matchesSearch ? '' : 'none';
        });
      }

      logSearch?.addEventListener('input', applyLogFilters);
      actionFilter?.addEventListener('change', applyLogFilters);
    </script>
  </body>
</html>
